<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-11-15T13:22:40.181020Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Envelope Ledger</title>
<style>
  :root {
    --color-bg-light: #f9f9f9;
    --color-bg-dark: #121212;
    --color-text-light: #222;
    --color-text-dark: #eee;
    --color-primary: #3a86ff;
    --color-warning: #ffb703;
    --color-critical: #d00000;
    --color-card-bg-light: #fff;
    --color-card-bg-dark: #1e1e1e;
    --color-border-light: #ccc;
    --color-border-dark: #333;
    --transition: 0.3s ease;
  }
  @media (prefers-color-scheme: dark) {
    body:not(.light) {
      background: var(--color-bg-dark);
      color: var(--color-text-dark);
    }
    body:not(.light) header,
    body:not(.light) footer {
      background: #222;
      border-color: var(--color-border-dark);
    }
    body:not(.light) .envelope-card {
      background: var(--color-card-bg-dark);
      border-color: var(--color-border-dark);
    }
    body:not(.light) button,
    body:not(.light) input,
    body:not(.light) select,
    body:not(.light) textarea {
      background: #222;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
  }
  body {
    margin: 0; padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: var(--color-bg-light);
    color: var(--color-text-light);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background var(--transition), color var(--transition);
  }
  header, footer {
    padding: 0.5rem 1rem;
    background: var(--color-card-bg-light);
    border-bottom: 1px solid var(--color-border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  header > * {
    margin: 0.25rem;
  }
  header h1 {
    font-weight: 600;
    font-size: 1.25rem;
    flex-grow: 1;
  }
  main {
    flex-grow: 1;
    padding: 1rem;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    display: flex;
    flex-direction: column;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  button {
    background: var(--color-primary);
    border: none;
    color: white;
    padding: 0.4rem 0.75rem;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background var(--transition);
  }
  button:hover,
  button:focus {
    background: #265ecf;
    outline: none;
  }
  button:disabled {
    background: #999;
    cursor: default;
  }
  label {
    font-weight: 600;
    margin-right: 0.25rem;
  }
  input[type="text"],
  input[type="number"],
  input[type="date"],
  textarea {
    font-size: 1rem;
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--color-border-light);
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
    transition: border-color var(--transition);
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="date"]:focus,
  textarea:focus {
    border-color: var(--color-primary);
    outline: none;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.5rem;
    min-width: 150px;
  }
  form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: flex-end;
  }
  .envelopes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
    gap: 1rem;
  }
  .envelope-card {
    background: var(--color-card-bg-light);
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .envelope-card:focus-within,
  .envelope-card:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
  }
  .envelope-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .envelope-name {
    font-weight: 700;
    font-size: 1.1rem;
    user-select: none;
  }
  .envelope-amounts {
    font-size: 0.9rem;
    user-select: none;
  }
  .allocation-bar {
    height: 16px;
    border-radius: 8px;
    background: #ddd;
    overflow: hidden;
    margin-bottom: 0.5rem;
    position: relative;
  }
  .allocation-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width 0.3s ease;
  }
  .allocation-fill.warning {
    background: var(--color-warning);
  }
  .allocation-fill.critical {
    background: var(--color-critical);
  }
  .envelope-expanded {
    margin-top: 0.5rem;
    border-top: 1px solid var(--color-border-light);
    padding-top: 0.5rem;
  }
  .transactions-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--color-border-light);
    border-radius: 4px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  th, td {
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid var(--color-border-light);
    text-align: left;
  }
  th {
    background: var(--color-primary);
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .transaction-amount {
    text-align: right;
    white-space: nowrap;
  }
  .transaction-date {
    white-space: nowrap;
  }
  .transaction-actions {
    text-align: center;
    white-space: nowrap;
  }
  .transaction-actions button {
    background: transparent;
    border: none;
    color: var(--color-critical);
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1rem;
    line-height: 1;
    padding: 0;
  }
  .transaction-actions button:hover,
  .transaction-actions button:focus {
    color: #ff4c4c;
    outline: none;
  }
  .add-transaction-form {
    margin-top: 0.5rem;
    border-top: 1px solid var(--color-border-light);
    padding-top: 0.5rem;
  }
  .add-transaction-form form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: flex-end;
  }
  .add-transaction-form .form-group {
    flex-grow: 1;
    min-width: 120px;
  }
  .footer-info {
    font-size: 0.8rem;
    color: #666;
  }
  .dark-toggle {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  .dark-toggle input[type="checkbox"] {
    width: 1.2rem;
    height: 1.2rem;
    cursor: pointer;
  }
  @media (max-width: 480px) {
    form {
      flex-direction: column;
      align-items: stretch;
    }
    .form-group {
      min-width: auto;
      width: 100%;
    }
    .envelope-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }
  .drag-handle {
    cursor: grab;
    user-select: none;
    margin-right: 0.5rem;
    font-size: 1.2rem;
    color: #888;
  }
  .dragging {
    opacity: 0.5;
  }
</style>
</head>
<body>
<header>
  <h1>Envelope Ledger</h1>
  <div class="dark-toggle" role="group" aria-label="Toggle dark mode">
    <label for="darkModeToggle">Dark Mode</label>
    <input type="checkbox" id="darkModeToggle" aria-checked="false" />
  </div>
  <button id="exportBtn" aria-label="Export envelope data as JSON">Export</button>
  <button id="importBtn" aria-label="Import envelope data from JSON file">Import</button>
  <input type="file" id="importFile" accept="application/json" style="display:none" aria-hidden="true" />
</header>
<main>
  <section aria-label="Add new envelope">
    <form id="addEnvelopeForm" novalidate>
      <div class="form-group">
        <label for="envelopeName">Envelope Name</label>
        <input type="text" id="envelopeName" name="envelopeName" required autocomplete="off" />
      </div>
      <div class="form-group">
        <label for="envelopeAllocation">Monthly Allocation ($)</label>
        <input type="number" id="envelopeAllocation" name="envelopeAllocation" min="0" step="0.01" required />
      </div>
      <button type="submit" aria-label="Add new envelope">Add Envelope</button>
    </form>
  </section>
  <section aria-label="Envelope dashboard" id="envelopesSection" tabindex="0">
    <div class="envelopes-grid" id="envelopesGrid" role="list" aria-live="polite" aria-relevant="additions removals"></div>
  </section>
  <section style="margin-top:1rem;">
    <button id="monthlyResetBtn" aria-label="Reset monthly spending for all envelopes">Monthly Reset</button>
  </section>
</main>
<footer>
  <div class="footer-info" id="footerInfo" aria-live="polite" aria-atomic="true"></div>
</footer>
<script>
(() => {
  "use strict";

  // Data keys
  const STORAGE_KEY = 'envelopeLedgerData';

  // DOM elements
  const envelopesGrid = document.getElementById('envelopesGrid');
  const addEnvelopeForm = document.getElementById('addEnvelopeForm');
  const envelopeNameInput = document.getElementById('envelopeName');
  const envelopeAllocationInput = document.getElementById('envelopeAllocation');
  const monthlyResetBtn = document.getElementById('monthlyResetBtn');
  const footerInfo = document.getElementById('footerInfo');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFileInput = document.getElementById('importFile');

  // State
  let envelopes = [];
  let expandedEnvelopeId = null;
  let dragSrcEl = null;

  // Helpers
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(envelopes));
    updateFooter();
  }

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        envelopes = JSON.parse(raw);
        // Validate structure
        if (!Array.isArray(envelopes)) envelopes = [];
        else {
          envelopes.forEach(e => {
            if (!e.id) e.id = crypto.randomUUID();
            if (!Array.isArray(e.transactions)) e.transactions = [];
            if (typeof e.name !== 'string') e.name = 'Unnamed';
            if (typeof e.allocation !== 'number') e.allocation = 0;
          });
        }
      } catch {
        envelopes = [];
      }
    }
  }

  function formatCurrency(amount) {
    return '$' + amount.toFixed(2);
  }

  function formatDateISO(dateStr) {
    try {
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      return d.toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'});
    } catch {
      return '';
    }
  }

  function calculateSpent(envelope) {
    return envelope.transactions.reduce((sum, t) => sum + t.amount, 0);
  }

  function calculateRemaining(envelope) {
    return envelope.allocation - calculateSpent(envelope);
  }

  function getBudgetHealthClass(envelope) {
    const spent = calculateSpent(envelope);
    if (spent >= envelope.allocation) return 'critical';
    if (spent >= envelope.allocation * 0.8) return 'warning';
    return '';
  }

  function updateFooter() {
    const now = new Date();
    const lastUpdated = now.toLocaleString(undefined, {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const dataSize = localStorage.getItem(STORAGE_KEY)?.length || 0;
    footerInfo.textContent = `Last updated: ${lastUpdated} | Data size: ${dataSize} bytes`;
  }

  // Dark mode
  function detectDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.remove('light');
      darkModeToggle.checked = true;
      darkModeToggle.setAttribute('aria-checked', 'true');
    } else if (localStorage.getItem('darkMode') === 'false') {
      document.body.classList.add('light');
      darkModeToggle.checked = false;
      darkModeToggle.setAttribute('aria-checked', 'false');
    } else {
      // Auto-detect
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.remove('light');
        darkModeToggle.checked = true;
        darkModeToggle.setAttribute('aria-checked', 'true');
      } else {
        document.body.classList.add('light');
        darkModeToggle.checked = false;
        darkModeToggle.setAttribute('aria-checked', 'false');
      }
    }
  }

  darkModeToggle.addEventListener('change', () => {
    if (darkModeToggle.checked) {
      document.body.classList.remove('light');
      localStorage.setItem('darkMode', 'true');
      darkModeToggle.setAttribute('aria-checked', 'true');
    } else {
      document.body.classList.add('light');
      localStorage.setItem('darkMode', 'false');
      darkModeToggle.setAttribute('aria-checked', 'false');
    }
  });

  // Envelope rendering
  function renderEnvelopes() {
    envelopesGrid.innerHTML = '';
    envelopes.forEach((env, index) => {
      const card = document.createElement('article');
      card.className = 'envelope-card';
      card.setAttribute('role', 'listitem');
      card.setAttribute('tabindex', '0');
      card.dataset.id = env.id;
      card.dataset.index = index;

      // Drag handle
      const dragHandle = document.createElement('span');
      dragHandle.className = 'drag-handle';
      dragHandle.setAttribute('aria-label', 'Drag to reorder envelope');
      dragHandle.setAttribute('tabindex', '-1');
      dragHandle.textContent = '☰';
      card.appendChild(dragHandle);

      // Header
      const header = document.createElement('div');
      header.className = 'envelope-header';

      const nameEl = document.createElement('div');
      nameEl.className = 'envelope-name';
      nameEl.textContent = env.name;
      header.appendChild(nameEl);

      const amountsEl = document.createElement('div');
      amountsEl.className = 'envelope-amounts';
      const spent = calculateSpent(env);
      const remaining = calculateRemaining(env);
      amountsEl.textContent = `${formatCurrency(env.allocation)} budgeted | ${formatCurrency(spent)} spent | ${formatCurrency(remaining)} remaining`;
      header.appendChild(amountsEl);

      card.appendChild(header);

      // Allocation bar
      const bar = document.createElement('div');
      bar.className = 'allocation-bar';
      const fill = document.createElement('div');
      fill.className = 'allocation-fill ' + getBudgetHealthClass(env);
      const fillPercent = env.allocation === 0 ? 0 : Math.min(100, (spent / env.allocation) * 100);
      fill.style.width = fillPercent + '%';
      fill.setAttribute('aria-label', `Spent ${fillPercent.toFixed(0)}% of allocation`);
      bar.appendChild(fill);
      card.appendChild(bar);

      // Expanded transactions view
      if (expandedEnvelopeId === env.id) {
        const expanded = document.createElement('section');
        expanded.className = 'envelope-expanded';
        expanded.setAttribute('aria-live', 'polite');

        // Transactions table
        const transactionsDiv = document.createElement('div');
        transactionsDiv.className = 'transactions-list';
        transactionsDiv.tabIndex = 0;
        transactionsDiv.setAttribute('aria-label', `Transactions for ${env.name}`);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');
        ['Date', 'Amount', 'Description', ''].forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        env.transactions.forEach((t, i) => {
          const tr = document.createElement('tr');
          tr.tabIndex = -1;
          tr.dataset.txIndex = i;

          const tdDate = document.createElement('td');
          tdDate.className = 'transaction-date';
          tdDate.textContent = formatDateISO(t.date);
          tr.appendChild(tdDate);

          const tdAmount = document.createElement('td');
          tdAmount.className = 'transaction-amount';
          tdAmount.textContent = formatCurrency(t.amount);
          tr.appendChild(tdAmount);

          const tdDesc = document.createElement('td');
          tdDesc.textContent = t.description || '';
          tr.appendChild(tdDesc);

          const tdActions = document.createElement('td');
          tdActions.className = 'transaction-actions';
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.title = 'Delete transaction';
          delBtn.setAttribute('aria-label', `Delete transaction on ${formatDateISO(t.date)} amount ${formatCurrency(t.amount)}`);
          delBtn.textContent = '×';
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('Delete this transaction?')) {
              env.transactions.splice(i, 1);
              saveData();
              renderEnvelopes();
            }
          });
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        transactionsDiv.appendChild(table);
        expanded.appendChild(transactionsDiv);

        // Add transaction form
        const addTxDiv = document.createElement('div');
        addTxDiv.className = 'add-transaction-form';
        const addTxForm = document.createElement('form');
        addTxForm.setAttribute('aria-label', `Add transaction to ${env.name}`);

        // Amount
        const fgAmount = document.createElement('div');
        fgAmount.className = 'form-group';
        const labelAmount = document.createElement('label');
        labelAmount.setAttribute('for', `txAmount-${env.id}`);
        labelAmount.textContent = 'Amount ($)';
        const inputAmount = document.createElement('input');
        inputAmount.type = 'number';
        inputAmount.id = `txAmount-${env.id}`;
        inputAmount.name = 'amount';
        inputAmount.step = '0.01';
        inputAmount.min = '0.01';
        inputAmount.required = true;
        inputAmount.autocomplete = 'off';
        fgAmount.appendChild(labelAmount);
        fgAmount.appendChild(inputAmount);
        addTxForm.appendChild(fgAmount);

        // Date
        const fgDate = document.createElement('div');
        fgDate.className = 'form-group';
        const labelDate = document.createElement('label');
        labelDate.setAttribute('for', `txDate-${env.id}`);
        labelDate.textContent = 'Date';
        const inputDate = document.createElement('input');
        inputDate.type = 'date';
        inputDate.id = `txDate-${env.id}`;
        inputDate.name = 'date';
        inputDate.required = true;
        inputDate.valueAsDate = new Date();
        fgDate.appendChild(labelDate);
        fgDate.appendChild(inputDate);
        addTxForm.appendChild(fgDate);

        // Description
        const fgDesc = document.createElement('div');
        fgDesc.className = 'form-group';
        const labelDesc = document.createElement('label');
        labelDesc.setAttribute('for', `txDesc-${env.id}`);
        labelDesc.textContent = 'Description (optional)';
        const inputDesc = document.createElement('input');
        inputDesc.type = 'text';
        inputDesc.id = `txDesc-${env.id}`;
        inputDesc.name = 'description';
        inputDesc.autocomplete = 'off';
        fgDesc.appendChild(labelDesc);
        fgDesc.appendChild(inputDesc);
        addTxForm.appendChild(fgDesc);

        // Submit button
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.textContent = 'Add Transaction';
        addTxForm.appendChild(submitBtn);

        addTxForm.addEventListener('submit', e => {
          e.preventDefault();
          const formData = new FormData(addTxForm);
          const amount = parseFloat(formData.get('amount'));
          const date = formData.get('date');
          const description = formData.get('description').trim();

          if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid positive amount.');
            inputAmount.focus();
            return;
          }
          if (!date) {
            alert('Please select a valid date.');
            inputDate.focus();
            return;
          }
          env.transactions.push({ amount, date, description });
          saveData();
          renderEnvelopes();
        });

        addTxDiv.appendChild(addTxForm);
        expanded.appendChild(addTxDiv);

        card.appendChild(expanded);
      }

      // Click / keyboard to expand/collapse
      card.addEventListener('click', (e) => {
        if (e.target.classList.contains('drag-handle')) return;
        toggleEnvelopeExpand(env.id);
      });
      card.addEventListener('keydown', (e) => {
        if (e.target !== card) return;
        if (e.key === 'Enter') {
          e.preventDefault();
          toggleEnvelopeExpand(env.id);
        } else if (e.key === 'Escape' && expandedEnvelopeId === env.id) {
          e.preventDefault();
          expandedEnvelopeId = null;
          renderEnvelopes();
          card.focus();
        }
      });

      // Drag and drop handlers
      dragHandle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        card.setAttribute('draggable', 'true');
        card.focus();
        card.dispatchEvent(new MouseEvent('dragstart', { bubbles: true }));
      });
      card.addEventListener('dragstart', (e) => {
        dragSrcEl = card;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', env.id);
      });
      card.addEventListener('dragend', (e) => {
        card.classList.remove('dragging');
        card.removeAttribute('draggable');
        dragSrcEl = null;
      });
      card.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });
      card.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!dragSrcEl || dragSrcEl === card) return;
        const srcId = e.dataTransfer.getData('text/plain');
        const tgtId = card.dataset.id;
        const srcIndex = envelopes.findIndex(en => en.id === srcId);
        const tgtIndex = envelopes.findIndex(en => en.id === tgtId);
        if (srcIndex < 0 || tgtIndex < 0) return;
        // Reorder
        const [moved] = envelopes.splice(srcIndex, 1);
        envelopes.splice(tgtIndex, 0, moved);
        saveData();
        renderEnvelopes();
        // Focus moved card
        const cards = envelopesGrid.querySelectorAll('.envelope-card');
        if (cards[tgtIndex]) cards[tgtIndex].focus();
      });

      envelopesGrid.appendChild(card);
    });
    renderDashboardSummary();
  }

  function toggleEnvelopeExpand(id) {
    if (expandedEnvelopeId === id) {
      expandedEnvelopeId = null;
    } else {
      expandedEnvelopeId = id;
    }
    renderEnvelopes();
  }

  // Dashboard summary
  function renderDashboardSummary() {
    // Total budgeted, spent, remaining
    const totalBudgeted = envelopes.reduce((sum, e) => sum + e.allocation, 0);
    const totalSpent = envelopes.reduce((sum, e) => sum + calculateSpent(e), 0);
    const totalRemaining = totalBudgeted - totalSpent;

    // Create or update summary display above envelopes grid
    let summary = document.getElementById('dashboardSummary');
    if (!summary) {
      summary = document.createElement('section');
      summary.id = 'dashboardSummary';
      summary.setAttribute('aria-label', 'Budget summary');
      summary.style.marginBottom = '1rem';
      summary.style.fontWeight = '600';
      summary.style.fontSize = '1rem';
      summary.style.display = 'flex';
      summary.style.flexWrap = 'wrap';
      summary.style.gap = '1rem';
      summary.style.justifyContent = 'center';
      document.querySelector('main').insertBefore(summary, envelopesGrid);
    }
    summary.innerHTML = `
      <div>Total Budgeted: ${formatCurrency(totalBudgeted)}</div>
      <div>Total Spent: ${formatCurrency(totalSpent)}</div>
      <div>Remaining Balance: ${formatCurrency(totalRemaining)}</div>
      <div>Budget Health: ${getOverallBudgetHealth(totalSpent, totalBudgeted)}</div>
    `;
  }

  function getOverallBudgetHealth(spent, budgeted) {
    if (budgeted === 0) return 'No budget set';
    const ratio = spent / budgeted;
    if (ratio >= 1) return 'Critical (100% or more spent)';
    if (ratio >= 0.8) return 'Warning (80% or more spent)';
    return 'Healthy';
  }

  // Add envelope form submission
  addEnvelopeForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = envelopeNameInput.value.trim();
    const allocationRaw = envelopeAllocationInput.value.trim();
    const allocation = parseFloat(allocationRaw);
    if (!name) {
      alert('Envelope name cannot be empty.');
      envelopeNameInput.focus();
      return;
    }
    if (isNaN(allocation) || allocation < 0) {
      alert('Allocation must be a non-negative number.');
      envelopeAllocationInput.focus();
      return;
    }
    envelopes.push({
      id: crypto.randomUUID(),
      name,
      allocation,
      transactions: []
    });
    envelopeNameInput.value = '';
    envelopeAllocationInput.value = '';
    saveData();
    renderEnvelopes();
    envelopeNameInput.focus();
  });

  // Monthly reset button
  monthlyResetBtn.addEventListener('click', () => {
    if (!confirm('This will clear all spent amounts (transactions) but keep envelope structure. Proceed?')) return;
    envelopes.forEach(env => {
      env.transactions = [];
    });
    saveData();
    expandedEnvelopeId = null;
    renderEnvelopes();
  });

  // Export button
  exportBtn.addEventListener('click', () => {
    const dataStr = JSON.stringify(envelopes, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'envelope-ledger-export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Import button
  importBtn.addEventListener('click', () => {
    importFileInput.value = null;
    importFileInput.click();
  });

  importFileInput.addEventListener('change', () => {
    const file = importFileInput.files;
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        if (!Array.isArray(imported)) throw new Error('Invalid data format');
        // Validate imported data
        for (const env of imported) {
          if (typeof env.name !== 'string' || typeof env.allocation !== 'number' || !Array.isArray(env.transactions)) {
            throw new Error('Invalid envelope data');
          }
          env.id = env.id || crypto.randomUUID();
          env.transactions.forEach(t => {
            if (typeof t.amount !== 'number' || typeof t.date !== 'string') {
              throw new Error('Invalid transaction data');
            }
          });
        }
        envelopes = imported;
        expandedEnvelopeId = null;
        saveData();
        renderEnvelopes();
        alert('Data imported successfully.');
      } catch (ex) {
        alert('Failed to import data: ' + ex.message);
      }
    };
    reader.readAsText(file);
  });

  // Keyboard navigation for transactions list
  envelopesGrid.addEventListener('keydown', e => {
    if (!expandedEnvelopeId) return;
    const card = e.target.closest('.envelope-card');
    if (!card || card.dataset.id !== expandedEnvelopeId) return;
    const transactionsDiv = card.querySelector('.transactions-list');
    if (!transactionsDiv) return;
    const rows = Array.from(transactionsDiv.querySelectorAll('tbody tr'));
    if (!rows.length) return;
    let currentIndex = rows.findIndex(r => r === document.activeElement);
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (currentIndex < rows.length - 1) rows[currentIndex + 1].focus();
      else rows.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (currentIndex > 0) rows[currentIndex - 1].focus();
      else rows[rows.length - 1].focus();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      expandedEnvelopeId = null;
      renderEnvelopes();
      const envelopeCard = envelopesGrid.querySelector(`.envelope-card[data-id="${card.dataset.id}"]`);
      if (envelopeCard) envelopeCard.focus();
    }
  });

  // Initialization
  function init() {
    detectDarkMode();
    loadData();
    renderEnvelopes();
    updateFooter();
  }

  init();

})();
</script>
</body>
</html>